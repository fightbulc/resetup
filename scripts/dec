#!/usr/bin/env bash

echo "# decrypt data"

# Attempt decryption
if ! openssl aes256 -d -pbkdf2 -salt -in data.aes256 -out data.tar.gz; then
    echo "❌ Decryption failed - incorrect password or corrupted data"
    # Clean up any partial file
    rm -f data.tar.gz
    exit 1
fi

# Verify the decrypted file is a valid gzip archive
if ! file data.tar.gz | grep -q "gzip compressed"; then
    echo "❌ Decrypted file is not a valid archive - incorrect password"
    rm -f data.tar.gz
    exit 1
fi

# Extract the archive
if ! tar -xf data.tar.gz > /dev/null; then
    echo "❌ Failed to extract archive - data may be corrupted"
    rm -f data.tar.gz
    exit 1
fi

# Clean up
rm data.tar.gz

echo "✅ Decryption successful"
