#!/usr/bin/env bash

set -e

# Check for -y and -f flags
AUTO_CONFIRM=false
FORCE_REINSTALL=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -y)
            AUTO_CONFIRM=true
            echo "Debug: AUTO_CONFIRM set to true"
            shift
            ;;
        -f)
            FORCE_REINSTALL=true
            echo "Debug: FORCE_REINSTALL set to true"
            shift
            ;;
        *)
            break
            ;;
    esac
done

echo "Debug: Final flags - AUTO_CONFIRM=$AUTO_CONFIRM, FORCE_REINSTALL=$FORCE_REINSTALL"
echo "Debug: Remaining arguments: $*"

#
# CHECK PACKAGES
#

# Check if we have the correct yq (Go-based, not Python-based)
if ! /usr/local/bin/yq --version &> /dev/null || ! /usr/local/bin/yq eval '.test' <<< 'test: value' &> /dev/null; then
    echo "Go-based yq is required but not installed. Installing..."
    sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
    sudo chmod +x /usr/local/bin/yq
    echo "âœ… Go-based yq installed successfully"
fi

# Ensure we use the correct yq
export PATH="/usr/local/bin:$PATH"

#
# SET BASE VARIABLES
#

BASE_PATH=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &> /dev/null && cd .. && pwd)
MASTER_CNF_PATH="$BASE_PATH/data/config/master.cnf"
RECIPES_CONFIG="$BASE_PATH/recipes.yaml"

#
# CHECK REQUIREMENTS
#

if [ ! -f "$MASTER_CNF_PATH" ]; then
    echo "Master config not found at: $MASTER_CNF_PATH"
    echo "Please run './unpack' first to decrypt your configuration"
    exit 1
fi

if [ ! -f "$RECIPES_CONFIG" ]; then
    echo "Recipes configuration not found at: $RECIPES_CONFIG"
    exit 1
fi

#
# CREATE SOURCE DIRECTORY
#

mkdir -p $BASE_PATH/source

#
# FUNCTIONS
#

run_recipe() {
    local recipe_name=$1

    local recipe_script;
    recipe_script=$(yq eval ".recipes[] | select(.name == \"$recipe_name\") | .script" "$RECIPES_CONFIG")

    local recipe_desc;
    recipe_desc=$(yq eval ".recipes[] | select(.name == \"$recipe_name\") | .description" "$RECIPES_CONFIG")
    
    if [ -z "$recipe_script" ]; then
        echo "Recipe '$recipe_name' not found in configuration"
        return 1
    fi
    
    local script_path="$BASE_PATH/recipes/$recipe_script"
    
    if [ ! -f "$script_path" ]; then
        echo "Recipe script not found: $script_path"
        return 1
    fi
    
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘ Recipe: $recipe_name"
    echo "â•‘ Description: $recipe_desc"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    
    if [[ "$AUTO_CONFIRM" == "true" ]]; then
        echo "Auto-confirming recipe: $recipe_name"
    else
        read -p "Run this recipe? [Y/n] " -n 1 -r
        echo
        
        if [[ $REPLY =~ ^[Nn]$ ]]; then
            echo "Skipping $recipe_name"
            return 0
        fi
    fi
    
    bash "$script_path" "$MASTER_CNF_PATH" "$BASE_PATH"
    
    # Source bashrc after each recipe to pick up any environment changes
    # shellcheck source=/dev/null
    source ~/.bashrc 2>/dev/null || true
}

get_recipe_dependencies() {
    local recipe_name=$1
    yq eval ".recipes[] | select(.name == \"$recipe_name\") | .dependencies[]" "$RECIPES_CONFIG" 2>/dev/null || true
}

is_recipe_installed() {
    local recipe_name=$1
    # For now, we'll track installed recipes in a file
    local installed_file="$BASE_PATH/.installed_recipes"
    
    if [ -f "$installed_file" ] && grep -q "^$recipe_name$" "$installed_file"; then
        return 0
    fi
    return 1
}

mark_recipe_installed() {
    local recipe_name=$1
    local installed_file="$BASE_PATH/.installed_recipes"
    echo "$recipe_name" >> "$installed_file"
}

install_recipe_with_deps() {
    local recipe_name=$1
    local visited_file;

    visited_file=$(mktemp)
    
    _install_recipe_recursive "$recipe_name" "$visited_file"
    
    rm -f "$visited_file"
}

_install_recipe_recursive() {
    local recipe_name=$1
    local visited_file=$2
    
    # Check if already visited (circular dependency check)
    if grep -q "^$recipe_name$" "$visited_file" 2>/dev/null; then
        return 0
    fi
    echo "$recipe_name" >> "$visited_file"
    
    # Check if already installed (unless force reinstall is enabled)
    if [[ "$FORCE_REINSTALL" == "false" ]] && is_recipe_installed "$recipe_name"; then
        echo "Recipe '$recipe_name' is already installed"
        return 0
    elif [[ "$FORCE_REINSTALL" == "true" ]] && is_recipe_installed "$recipe_name"; then
        echo "Force reinstalling recipe '$recipe_name' (FORCE_REINSTALL=$FORCE_REINSTALL)"
    elif [[ "$FORCE_REINSTALL" == "true" ]]; then
        echo "Installing recipe '$recipe_name' with force flag (not previously installed)"
    fi
    
    # Install dependencies first
    local deps
    deps=$(get_recipe_dependencies "$recipe_name")
    if [ -n "$deps" ]; then
        for dep in $deps; do
            if [ -n "$dep" ]; then
                _install_recipe_recursive "$dep" "$visited_file"
            fi
        done
    fi
    
    # Install the recipe
    run_recipe "$recipe_name"
    mark_recipe_installed "$recipe_name"
}

#
# MAIN LOGIC
#

if [ $# -eq 1 ]; then
    # Install specific recipe with dependencies
    RECIPE_NAME="$1"
    install_recipe_with_deps "$RECIPE_NAME"
    
    # Show completion message for single recipe
    echo ""
    echo "=============================================="
    echo "âœ… RECIPE INSTALLATION COMPLETE!"
    echo "=============================================="
    echo ""
    echo "ðŸ“¦ Recipe '$RECIPE_NAME' installed successfully"
    echo ""
    echo "ðŸ”„ Refreshing environment..."
    # shellcheck source=/dev/null
    source ~/.bashrc 2>/dev/null || true
    echo ""
    echo "ðŸŽ‰ Ready to use $RECIPE_NAME!"
    echo ""
    exit 0
elif [ $# -gt 1 ]; then
    # Install multiple specific recipes
    echo ""
    echo "ðŸš€ Installing $# specified recipes..."
    echo ""
    
    for RECIPE_NAME in "$@"; do
        install_recipe_with_deps "$RECIPE_NAME"
    done
    
    # Show completion message for multiple recipes
    echo ""
    echo "=============================================="
    echo "âœ… RECIPE INSTALLATION COMPLETE!"
    echo "=============================================="
    echo ""
    echo "ðŸ“¦ $# recipes installed successfully"
    echo ""
    echo "ðŸ”„ Refreshing environment..."
    # shellcheck source=/dev/null
    source ~/.bashrc 2>/dev/null || true
    echo ""
    echo "ðŸŽ‰ Ready to use your tools!"
    echo ""
    exit 0
else
    # Install all recipes in order
    TOTAL_RECIPES=$(yq eval '.recipes | length' "$RECIPES_CONFIG")
    echo ""
    echo "ðŸš€ Starting installation of $TOTAL_RECIPES recipes..."
    echo "   This may take several minutes depending on your system"
    echo ""
    
    for recipe_name in $(yq eval '.recipes[].name' "$RECIPES_CONFIG"); do
        install_recipe_with_deps "$recipe_name"
    done
fi

#
# CLEANUP
#

rm -rf "$BASE_PATH/source"

#
# SOURCE BASHRC
#

echo ""
echo "=================================================="
echo "ðŸŽ‰ RESETUP INSTALLATION COMPLETE!"
echo "=================================================="
echo ""

# Count installed recipes
INSTALLED_COUNT=$(wc -l < "$BASE_PATH/.installed_recipes" 2>/dev/null || echo "0")
echo "ðŸ“Š Summary:"
echo "   â€¢ $INSTALLED_COUNT recipes installed successfully"
echo "   â€¢ Environment configured and ready"
echo ""

echo "ðŸ”„ Refreshing environment..."
# shellcheck source=/dev/null
source ~/.bashrc

echo ""
echo "âœ… Your development environment is now set up!"
echo ""
echo "ðŸ’¡ What's next?"
echo "   â€¢ Open a new terminal to ensure all changes take effect"
echo "   â€¢ Check installed tools with: which node, which docker, etc."
echo "   â€¢ Review ~/.bashrc for any customizations"
echo ""
echo "ðŸš€ Happy coding!"
echo ""